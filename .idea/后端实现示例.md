# 智能锁开锁系统 - 后端实现示例

基于前端代码分析，提供完整的Spring Boot后端实现方案。

## 一、项目结构

```
backend/
├── src/main/java/com/example/lock/
│   ├── controller/
│   │   └── BluetoothBaseController.java
│   ├── service/
│   │   └── BluetoothBaseService.java
│   ├── entity/
│   │   ├── BluetoothBase.java
│   │   └── UseRecord.java
│   ├── repository/
│   │   ├── BluetoothBaseRepository.java
│   │   └── UseRecordRepository.java
│   └── dto/
│       ├── BluetoothBaseInfoDTO.java
│       ├── UseRecordDTO.java
│       └── ElectQuantityDTO.java
└── src/main/resources/
    └── application.yml
```

## 二、实体类实现

### 1. BluetoothBase.java (设备信息实体)

```java
package com.example.lock.entity;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;

@Entity
@Table(name = "bluetooth_base")
@Data
public class BluetoothBase {
    
    @Id
    @Column(name = "id", length = 64)
    private String id;
    
    @Column(name = "lock_num", length = 100)
    private String lockNum;
    
    @Column(name = "mac", length = 20)
    private String mac;
    
    @Column(name = "blue_type", length = 10)
    private String blueType;
    
    @Column(name = "password", length = 255)
    private String password;
    
    @Column(name = "secret_key", length = 255)
    private String secretKey;
    
    @Column(name = "use_count")
    private Integer useCount = 0;
    
    @Column(name = "last_user", length = 100)
    private String lastUser;
    
    @Column(name = "last_use_time")
    private LocalDateTime lastUseTime;
    
    @Column(name = "is_instruct_closed", length = 1)
    private String isInstructClosed = "0";
    
    @Column(name = "answer_question", length = 1)
    private String answerQuestion = "0";
    
    @Column(name = "elect_quantity")
    private Integer electQuantity;
    
    @Column(name = "create_time")
    private LocalDateTime createTime;
    
    @Column(name = "update_time")
    private LocalDateTime updateTime;
    
    @PrePersist
    protected void onCreate() {
        createTime = LocalDateTime.now();
        updateTime = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updateTime = LocalDateTime.now();
    }
}
```

### 2. UseRecord.java (使用记录实体)

```java
package com.example.lock.entity;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;

@Entity
@Table(name = "use_records")
@Data
public class UseRecord {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "bluetooth_id", length = 64)
    private String bluetoothId;
    
    @Column(name = "user_id", length = 64)
    private String userId;
    
    @Column(name = "lock_status")
    private Integer lockStatus; // 1=开锁, 0=关锁
    
    @Column(name = "create_time")
    private LocalDateTime createTime;
    
    @PrePersist
    protected void onCreate() {
        createTime = LocalDateTime.now();
    }
}
```

## 三、Repository层实现

### 1. BluetoothBaseRepository.java

```java
package com.example.lock.repository;

import com.example.lock.entity.BluetoothBase;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BluetoothBaseRepository extends JpaRepository<BluetoothBase, String> {
}
```

### 2. UseRecordRepository.java

```java
package com.example.lock.repository;

import com.example.lock.entity.UseRecord;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UseRecordRepository extends JpaRepository<UseRecord, Long> {
}
```

## 四、DTO类实现

### 1. BluetoothBaseInfoDTO.java

```java
package com.example.lock.dto;

import lombok.Data;
import java.util.List;

@Data
public class BluetoothBaseInfoDTO {
    private String id;
    private String lockNum;
    private String mac;
    private String blueType;
    private String password;
    private String secretKey;
    private Integer useCount;
    private String lastUser;
    private String lastUseTime;
    private String isInstructClosed;
    private String answerQuestion;
    private String operType;
    private List<RecordDTO> records;
    private String message;
    
    @Data
    public static class RecordDTO {
        private String name;
    }
}
```

### 2. UseRecordDTO.java

```java
package com.example.lock.dto;

import lombok.Data;

@Data
public class UseRecordDTO {
    private String bluetoothId;
    private String userId;
    private Integer lockStatus; // 1=开锁, 0=关锁
}
```

### 3. ElectQuantityDTO.java

```java
package com.example.lock.dto;

import lombok.Data;

@Data
public class ElectQuantityDTO {
    private String bluetoothId;
    private String electQuantity;
}
```

## 五、Service层实现

### BluetoothBaseService.java

```java
package com.example.lock.service;

import com.example.lock.dto.BluetoothBaseInfoDTO;
import com.example.lock.dto.UseRecordDTO;
import com.example.lock.dto.ElectQuantityDTO;
import com.example.lock.entity.BluetoothBase;
import com.example.lock.entity.UseRecord;
import com.example.lock.repository.BluetoothBaseRepository;
import com.example.lock.repository.UseRecordRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class BluetoothBaseService {
    
    private final BluetoothBaseRepository bluetoothBaseRepository;
    private final UseRecordRepository useRecordRepository;
    
    private static final DateTimeFormatter DATE_FORMATTER = 
        DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");
    
    /**
     * 获取设备信息
     */
    public BluetoothBaseInfoDTO getBluetoothBaseInfo(String id) {
        Optional<BluetoothBase> optional = bluetoothBaseRepository.findById(id);
        
        if (optional.isEmpty()) {
            BluetoothBaseInfoDTO dto = new BluetoothBaseInfoDTO();
            dto.setMessage("设备不存在");
            return dto;
        }
        
        BluetoothBase base = optional.get();
        BluetoothBaseInfoDTO dto = new BluetoothBaseInfoDTO();
        
        dto.setId(base.getId());
        dto.setLockNum(base.getLockNum());
        dto.setMac(base.getMac());
        dto.setBlueType(base.getBlueType());
        dto.setPassword(base.getPassword());
        dto.setSecretKey(base.getSecretKey());
        dto.setUseCount(base.getUseCount());
        dto.setLastUser(base.getLastUser());
        
        if (base.getLastUseTime() != null) {
            dto.setLastUseTime(base.getLastUseTime().format(DATE_FORMATTER));
        }
        
        dto.setIsInstructClosed(base.getIsInstructClosed());
        dto.setAnswerQuestion(base.getAnswerQuestion());
        dto.setOperType("1");
        dto.setRecords(new ArrayList<>());
        dto.setMessage("success");
        
        return dto;
    }
    
    /**
     * 添加使用记录
     */
    @Transactional
    public boolean addUseRecords(UseRecordDTO dto) {
        try {
            UseRecord record = new UseRecord();
            record.setBluetoothId(dto.getBluetoothId());
            record.setUserId(dto.getUserId());
            record.setLockStatus(dto.getLockStatus());
            
            useRecordRepository.save(record);
            
            // 更新设备信息
            Optional<BluetoothBase> optional = 
                bluetoothBaseRepository.findById(dto.getBluetoothId());
            
            if (optional.isPresent()) {
                BluetoothBase base = optional.get();
                base.setUseCount(base.getUseCount() + 1);
                // 这里应该从用户服务获取用户名，示例中简化处理
                base.setLastUser(dto.getUserId());
                base.setLastUseTime(LocalDateTime.now());
                bluetoothBaseRepository.save(base);
            }
            
            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * 更新电量
     */
    @Transactional
    public boolean updateElectQuantity(ElectQuantityDTO dto) {
        try {
            Optional<BluetoothBase> optional = 
                bluetoothBaseRepository.findById(dto.getBluetoothId());
            
            if (optional.isPresent()) {
                BluetoothBase base = optional.get();
                base.setElectQuantity(Integer.parseInt(dto.getElectQuantity()));
                bluetoothBaseRepository.save(base);
                return true;
            }
            
            return false;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }
}
```

## 六、Controller层实现

### BluetoothBaseController.java

```java
package com.example.lock.controller;

import com.example.lock.dto.BluetoothBaseInfoDTO;
import com.example.lock.dto.UseRecordDTO;
import com.example.lock.dto.ElectQuantityDTO;
import com.example.lock.service.BluetoothBaseService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/lock/bluetoothBase")
@RequiredArgsConstructor
public class BluetoothBaseController {
    
    private final BluetoothBaseService bluetoothBaseService;
    
    /**
     * 获取设备信息
     * POST /lock/bluetoothBase/getBluetoothBaseInfo?id=xxx
     */
    @PostMapping("/getBluetoothBaseInfo")
    public ResponseEntity<BluetoothBaseInfoDTO> getBluetoothBaseInfo(
            @RequestParam String id) {
        BluetoothBaseInfoDTO dto = bluetoothBaseService.getBluetoothBaseInfo(id);
        return ResponseEntity.ok(dto);
    }
    
    /**
     * 添加使用记录
     * POST /lock/bluetoothBase/addUseRecords
     */
    @PostMapping("/addUseRecords")
    public ResponseEntity<Map<String, Object>> addUseRecords(
            @RequestBody UseRecordDTO dto) {
        Map<String, Object> result = new HashMap<>();
        
        boolean success = bluetoothBaseService.addUseRecords(dto);
        
        if (success) {
            result.put("status", 200);
            result.put("data", true);
            result.put("message", "操作成功");
        } else {
            result.put("status", 500);
            result.put("data", false);
            result.put("message", "操作失败");
        }
        
        return ResponseEntity.ok(result);
    }
    
    /**
     * 更新电量
     * POST /lock/bluetoothBase/updateElectQuantity
     */
    @PostMapping("/updateElectQuantity")
    public ResponseEntity<Map<String, Object>> updateElectQuantity(
            @RequestBody ElectQuantityDTO dto) {
        Map<String, Object> result = new HashMap<>();
        
        boolean success = bluetoothBaseService.updateElectQuantity(dto);
        
        if (success) {
            result.put("status", 200);
            result.put("data", true);
            result.put("message", "操作成功");
        } else {
            result.put("status", 500);
            result.put("data", false);
            result.put("message", "操作失败");
        }
        
        return ResponseEntity.ok(result);
    }
}
```

## 七、配置文件

### application.yml

```yaml
spring:
  application:
    name: smart-lock-service
  
  datasource:
    url: jdbc:mysql://localhost:3306/smart_lock?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true

server:
  port: 8080

logging:
  level:
    com.example.lock: DEBUG
```

## 八、依赖配置 (pom.xml)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.1.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>smart-lock-service</artifactId>
    <version>1.0.0</version>
    <name>Smart Lock Service</name>
    
    <properties>
        <java.version>17</java.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Spring Boot JPA -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <!-- MySQL Driver -->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>
        
        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        
        <!-- Validation -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

## 九、数据库初始化SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS smart_lock DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE smart_lock;

-- 设备信息表
CREATE TABLE IF NOT EXISTS bluetooth_base (
    id VARCHAR(64) PRIMARY KEY COMMENT '设备ID',
    lock_num VARCHAR(100) COMMENT '锁具编号',
    mac VARCHAR(20) COMMENT 'MAC地址',
    blue_type VARCHAR(10) COMMENT '锁类型（0/2/3）',
    password VARCHAR(255) COMMENT '密码',
    secret_key VARCHAR(255) COMMENT '密钥',
    use_count INT DEFAULT 0 COMMENT '使用次数',
    last_user VARCHAR(100) COMMENT '上次使用人',
    last_use_time DATETIME COMMENT '上次使用时间',
    is_instruct_closed VARCHAR(1) DEFAULT '0' COMMENT '是否有关锁功能（0/1）',
    answer_question VARCHAR(1) DEFAULT '0' COMMENT '是否需要答题（0/1）',
    elect_quantity INT COMMENT '电量',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_mac (mac),
    INDEX idx_lock_num (lock_num)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='蓝牙设备信息表';

-- 使用记录表
CREATE TABLE IF NOT EXISTS use_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    bluetooth_id VARCHAR(64) COMMENT '设备ID',
    user_id VARCHAR(64) COMMENT '用户ID',
    lock_status INT COMMENT '锁状态（1=开锁，0=关锁）',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_bluetooth_id (bluetooth_id),
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='使用记录表';

-- 插入测试数据
INSERT INTO bluetooth_base (id, lock_num, mac, blue_type, password, secret_key, use_count, is_instruct_closed, answer_question, elect_quantity) 
VALUES 
('test001', 'LOCK-001', 'AA:BB:CC:DD:EE:FF', '0', '1,2,3,4,5,6', '1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16', 0, '1', '0', 100),
('test002', 'LOCK-002', '11:22:33:44:55:66', '2', '123456', 'abcdef1234567890', 0, '0', '0', 80);
```

## 十、使用说明

1. **启动项目**
   ```bash
   mvn spring-boot:run
   ```

2. **测试接口**
   - 获取设备信息: `POST http://localhost:8080/lock/bluetoothBase/getBluetoothBaseInfo?id=test001`
   - 添加使用记录: `POST http://localhost:8080/lock/bluetoothBase/addUseRecords`
   - 更新电量: `POST http://localhost:8080/lock/bluetoothBase/updateElectQuantity`

3. **注意事项**
   - 需要根据实际环境修改数据库连接配置
   - 密码和密钥建议加密存储
   - 建议添加用户认证和权限校验
   - 建议添加接口日志记录

## 十一、扩展建议

1. **安全性增强**
   - 添加JWT认证
   - 接口访问权限控制
   - 敏感数据加密存储

2. **功能扩展**
   - 设备管理功能
   - 使用记录查询和统计
   - 电量预警功能
   - 设备状态监控

3. **性能优化**
   - 添加Redis缓存
   - 数据库连接池优化
   - 接口响应时间监控

