# 开锁功能移植指南

本文档详细说明将开锁功能从当前项目移植到新项目时需要注意的所有事项。

## 📋 目录

1. [项目架构概览](#项目架构概览)
2. [前端移植注意事项](#前端移植注意事项)
3. [后端移植注意事项](#后端移植注意事项)
4. [数据库结构要求](#数据库结构要求)
5. [关键依赖清单](#关键依赖清单)
6. [蓝牙协议相关](#蓝牙协议相关)
7. [配置文件说明](#配置文件说明)
8. [常见问题排查](#常见问题排查)

---

## 项目架构概览

### 技术栈
- **前端**: uni-app (Vue 3) + Vite
- **后端**: Spring Boot 2.6.13 + MyBatis Plus + MySQL
- **通信方式**: HTTP API + 蓝牙BLE

### 核心功能模块
1. **蓝牙连接管理**: 扫描、连接、断开蓝牙设备
2. **开锁/关锁控制**: 发送加密指令控制锁具
3. **电量监控**: 读取并上报设备电量
4. **使用记录**: 记录开锁/关锁操作历史
5. **权限验证**: 支持答题开锁、多人确认等权限控制

---

## 前端移植注意事项

### 1. 必需的文件清单

#### 核心页面文件
- `src/pages/lock/blueLock.vue` - 主开锁页面（1084行，核心逻辑）

#### 工具类文件（必须完整复制）
```
src/utils/
├── crypto.js              # AES加密解密工具（使用crypto-js）
├── request.js             # HTTP请求封装
├── util.js                # 工具函数（ab2hex, bytesToArrayBuffer等）
├── index.js               # URL参数解析工具
└── aes/                   # AES加密库（红色锁专用）
    ├── entry-export_all.js
    ├── aes/
    │   ├── aes.js
    │   ├── ccm.js         # AES-CCM加密（红色锁）
    │   └── ecb.js         # AES-ECB加密
    └── other/
        ├── utils.js
        └── errors.js
```

#### 配置文件
- `src/config/index.js` - API基础地址配置

### 2. 关键依赖包

在 `package.json` 中确保包含以下依赖：

```json
{
  "dependencies": {
    "@dcloudio/uni-app": "3.0.0-4080720251210001",
    "vue": "^3.4.21",
    "crypto-js": "^4.2.0",
    "buffer": "^6.0.3"
  }
}
```

**⚠️ 特别注意**:
- `buffer` 包是必需的，用于 ArrayBuffer 和 Buffer 之间的转换
- `crypto-js` 用于 AES 加密解密
- uni-app 版本需要兼容蓝牙API

### 3. uni-app 蓝牙API依赖

开锁功能依赖以下 uni-app 蓝牙API（这些是框架内置的，无需额外安装）：
- `uni.openBluetoothAdapter()` - 初始化蓝牙适配器
- `uni.startBluetoothDevicesDiscovery()` - 开始搜索蓝牙设备
- `uni.createBLEConnection()` - 创建BLE连接
- `uni.getBLEDeviceServices()` - 获取蓝牙服务
- `uni.getBLEDeviceCharacteristics()` - 获取特征值
- `uni.writeBLECharacteristicValue()` - 写入数据
- `uni.readBLECharacteristicValue()` - 读取数据
- `uni.onBLECharacteristicValueChange()` - 监听数据变化

**⚠️ 注意**: 这些API在不同平台（微信小程序、H5、App）的支持情况不同，需要根据目标平台进行测试。

### 4. 加密算法实现

#### 蓝色锁（blueType: 0, 3）
- 使用 **AES-ECB** 模式，NoPadding填充
- 加密函数: `encrypts()` 在 `crypto.js` 中
- 解密函数: `decrypts()` 在 `crypto.js` 中
- 密钥格式: 数组形式 `[1,2,3,...]`

#### 红色锁（blueType: 2）
- 使用 **AES-CCM** 模式
- 加密函数: `redAes.AES_CCM.encrypt()` 在 `aes/ccm.js` 中
- 解密函数: `redAes.AES_CCM.decrypt()` 在 `aes/ccm.js` 中
- 需要计算 nonce 值（从广播数据中提取）

### 5. 蓝牙服务UUID配置

不同锁类型使用不同的蓝牙服务UUID：

```javascript
// 蓝色锁（type 0, 3）
blueServiceId = "0000FEE7-0000-1000-8000-00805F9B34FB" // 从设备服务中查找

// 红色锁（type 2）
blueServiceId = "0000CCD0-0000-1000-8000-00805F9B34FB"
readCharacteristic = "0000CCD1-0000-1000-8000-00805F9B34FB"
writeCharacteristic = "0000CCD2-0000-1000-8000-00805F9B34FB"
```

### 6. 配置项修改

#### `src/config/index.js`
```javascript
export const baseURL = process.env.NODE_ENV === 'development' 
  ? 'http://YOUR_LOCAL_IP:8123/api'  // ⚠️ 修改为你的后端地址
  : 'https://your-api-domain.com/api';

export const getOpenLockAnswer = 'https://your-domain.com/answer/';  // ⚠️ 答题页面地址
```

**⚠️ 重要**: 
- 开发环境需要使用局域网IP，不能使用 `localhost`，因为手机无法访问
- 生产环境需要配置正确的域名

### 7. 存储依赖

代码中使用 `uni.getStorageSync()` 和 `uni.setStorageSync()` 存储：
- `token` - 用户认证令牌
- `user` - 用户信息（包含 userId）

确保新项目中这些存储键名一致，或修改代码中的键名。

---

## 后端移植注意事项

### 1. 必需的文件清单

```
src/main/java/cn/iocoder/cloud/lockdemo/
├── controller/
│   └── BluetoothBaseController.java      # API控制器
├── service/
│   ├── BluetoothBaseService.java         # 服务接口
│   └── impl/
│       ├── BluetoothBaseServiceImpl.java # 服务实现
│       └── UseRecordsServiceImpl.java    # 使用记录服务
├── entity/
│   ├── BluetoothBase.java                # 设备实体
│   └── UseRecords.java                   # 使用记录实体
├── dto/
│   ├── BluetoothBaseInfoDTO.java        # 设备信息DTO
│   ├── UseRecordDTO.java                # 使用记录DTO
│   ├── ElectQuantityDTO.java           # 电量DTO
│   └── Result.java                      # 统一响应格式
├── mapper/
│   ├── BluetoothBaseMapper.java         # MyBatis Mapper
│   └── UseRecordsMapper.java            # 使用记录Mapper
└── config/
    ├── MybatisPlusConfig.java           # MyBatis Plus配置
    └── CorsConfig.java                  # 跨域配置（如果需要）
```

### 2. 关键依赖包

在 `pom.xml` 中确保包含：

```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- MyBatis Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.5.9</version>
    </dependency>
    
    <!-- MySQL驱动 -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    
    <!-- Hutool工具类 -->
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.26</version>
    </dependency>
    
    <!-- API文档（可选） -->
    <dependency>
        <groupId>com.github.xiaoymin</groupId>
        <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
        <version>4.4.0</version>
    </dependency>
</dependencies>
```

### 3. API接口规范

#### 接口列表

1. **获取设备信息**
   - 路径: `POST /lock/bluetoothBase/getBluetoothBaseInfo`
   - 参数: `id` (query参数或body)
   - 返回: `Result<BluetoothBaseInfoDTO>`

2. **添加使用记录**
   - 路径: `POST /lock/bluetoothBase/addUseRecords`
   - 参数: `UseRecordDTO` (body)
   - 返回: `Result<Void>`

3. **更新电量**
   - 路径: `POST /lock/bluetoothBase/updateElectQuantity`
   - 参数: `ElectQuantityDTO` (body)
   - 返回: `Result<Void>`

#### 统一响应格式

所有接口必须返回 `Result<T>` 格式：

```java
public class Result<T> {
    private Integer code;      // 200表示成功
    private String message;    // 错误信息
    private T data;           // 数据
    private String operType;  // 操作类型（可选）
    private List records;      // 记录列表（可选）
}
```

**⚠️ 重要**: 前端 `request.js` 中已经处理了 `Result` 格式的响应，如果后端响应格式不一致，需要修改前端的响应处理逻辑。

### 4. 配置文件

#### `application.yml`
```yaml
server:
  port: 8123
  address: 0.0.0.0  # ⚠️ 必须绑定到0.0.0.0，允许局域网访问
  servlet:
    context-path: /api  # ⚠️ 确保与前端配置的baseURL一致

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/lockdemo?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password  # ⚠️ 修改为你的数据库密码

mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true
```

**⚠️ 注意**:
- `context-path: /api` 必须与前端 `baseURL` 中的路径一致
- 数据库连接信息需要根据实际情况修改

### 5. MyBatis Plus配置

确保 `MybatisPlusConfig.java` 中配置了分页插件（如果使用分页）：

```java
@Configuration
public class MybatisPlusConfig {
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        return interceptor;
    }
}
```

---

## 数据库结构要求

### 1. 必需的数据表

#### `bluetooth_base` 表（设备信息表）

```sql
CREATE TABLE `bluetooth_base` (
  `id` VARCHAR(64) PRIMARY KEY COMMENT '设备ID',
  `lock_num` VARCHAR(100) COMMENT '锁具编号',
  `mac` VARCHAR(20) COMMENT 'MAC地址',
  `blue_type` VARCHAR(10) COMMENT '锁类型（0/2/3）',
  `password` VARCHAR(200) COMMENT '密码（格式：逗号分隔的数字或16进制字符串）',
  `secret_key` VARCHAR(200) COMMENT '密钥（格式：逗号分隔的数字或16进制字符串）',
  `use_count` INT DEFAULT 0 COMMENT '使用次数',
  `last_user` VARCHAR(64) COMMENT '上次使用人ID',
  `last_use_time` DATETIME COMMENT '上次使用时间',
  `is_instruct_closed` VARCHAR(1) DEFAULT '0' COMMENT '是否有关锁功能（0/1）',
  `answer_question` VARCHAR(1) DEFAULT '0' COMMENT '是否需要答题（0/1）',
  `elect_quantity` INT COMMENT '电量（0-100）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_delete` TINYINT DEFAULT 0 COMMENT '逻辑删除标记（0未删除，1已删除）'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='蓝牙设备信息表';
```

#### `use_records` 表（使用记录表）

```sql
CREATE TABLE `use_records` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `bluetooth_id` VARCHAR(64) COMMENT '设备ID',
  `user_id` VARCHAR(64) COMMENT '用户ID',
  `lock_status` TINYINT COMMENT '锁状态（0关锁，1开锁）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_bluetooth_id` (`bluetooth_id`),
  INDEX `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='使用记录表';
```

### 2. 字段说明

#### `password` 和 `secret_key` 字段格式

- **蓝色锁（blueType: 0, 3）**: 存储为逗号分隔的数字字符串
  - 示例: `"1,2,3,4,5,6"` 或 `"10,20,30,40,50,60"`
  - 前端会使用 `.split(',').map(e => Number(e))` 转换为数组

- **红色锁（blueType: 2）**: 存储为16进制字符串
  - 示例: `"A1B2C3D4E5F6..."` (32位或更长)
  - 前端直接使用字符串

**⚠️ 重要**: 确保数据库中存储的格式与前端解析逻辑一致。

---

## 蓝牙协议相关

### 1. 锁类型说明

| blueType | 锁类型 | 加密方式 | 服务UUID | 说明 |
|----------|--------|----------|----------|------|
| 0 | 蓝色锁（标准） | AES-ECB | 0000FEE7-* | 标准蓝牙锁 |
| 2 | 红色锁 | AES-CCM | 0000CCD0-* | 需要CCM加密 |
| 3 | 蓝色锁（增强） | AES-ECB | 0000FEE7-* | 支持关锁功能 |

### 2. 开锁指令格式

#### 蓝色锁（type 0, 3）
```javascript
指令数组: [5, 1, 6, pwd[0], pwd[1], pwd[2], pwd[3], pwd[4], pwd[5], 
           token[3], token[4], token[5], token[6], 0, 0, 0]
// 如果支持关锁且需要开锁后自动关锁: 最后两个字节为 [0x5A, 0x78]
```

#### 红色锁（type 2）
```javascript
原始数据: "016E04" + password + "000000000000000000"
加密方式: AES-CCM加密
nonce: 从广播数据中计算得出
```

### 3. MAC地址提取

不同锁类型的MAC地址在广播数据中的位置不同：

```javascript
// 蓝色锁（type 0, 3）
mac = hexArr.slice(2, 8)  // 从索引2开始，取6个字节

// 红色锁（type 2）
mac = hexArr.slice(9, 15)  // 从索引9开始，取6个字节
```

### 4. 电量读取

- **蓝色锁**: 通过特征值通知获取，指令为 `[2, 1, 1, 1, token...]`
- **红色锁**: 通过读取特征值获取，需要AES-CCM解密

---

## 配置文件说明

### 前端配置

#### `src/config/index.js`
```javascript
// ⚠️ 必须修改的配置
export const baseURL = 'http://YOUR_IP:8123/api';
export const getOpenLockAnswer = 'https://your-domain.com/answer/';
```

#### `vite.config.js`
确保配置了正确的路径别名：
```javascript
resolve: {
  alias: {
    '@': path.resolve(__dirname, 'src')
  }
}
```

### 后端配置

#### `application.yml`
- 端口号: 默认8123，可修改
- context-path: 必须为 `/api`
- 数据库连接: 根据实际情况修改

---

## 常见问题排查

### 1. 蓝牙连接失败

**可能原因**:
- 手机蓝牙未开启
- 未授予蓝牙权限
- 锁具未唤醒（需要物理唤醒）
- MAC地址不匹配

**解决方法**:
- 检查 `uni.openBluetoothAdapter()` 是否成功
- 检查权限设置
- 确保锁具处于可连接状态
- 验证MAC地址格式和匹配逻辑

### 2. 开锁指令发送失败

**可能原因**:
- 未获取到token（蓝色锁）
- 加密算法错误
- 特征值UUID不正确
- 连接已断开

**解决方法**:
- 检查 `tokenDatas` 是否已获取
- 验证加密函数是否正确
- 确认服务UUID和特征UUID
- 检查连接状态

### 3. API请求失败

**可能原因**:
- baseURL配置错误
- 跨域问题
- token过期
- 后端服务未启动

**解决方法**:
- 检查 `config/index.js` 中的baseURL
- 后端配置CORS（如果需要）
- 检查token是否有效
- 确认后端服务运行正常

### 4. 电量读取失败

**可能原因**:
- 未订阅特征值通知
- 解密失败
- 数据格式错误

**解决方法**:
- 确保已调用 `uni.notifyBLECharacteristicValueChange()`
- 检查解密密钥是否正确
- 验证数据解析逻辑

### 5. 数据库操作失败

**可能原因**:
- 表结构不匹配
- 字段类型错误
- 逻辑删除字段未配置

**解决方法**:
- 检查表结构是否与实体类一致
- 确认字段类型匹配
- 检查 `is_delete` 字段配置

---

## 移植检查清单

### 前端检查项
- [ ] 所有工具类文件已复制
- [ ] `package.json` 依赖已安装
- [ ] `config/index.js` 已配置正确的API地址
- [ ] 路由配置已添加开锁页面
- [ ] 存储键名已统一（token, user）
- [ ] 蓝牙权限已配置（manifest.json）

### 后端检查项
- [ ] 所有Java文件已复制
- [ ] `pom.xml` 依赖已添加
- [ ] `application.yml` 已配置
- [ ] 数据库表已创建
- [ ] MyBatis Plus配置正确
- [ ] CORS配置（如需要）

### 功能测试项
- [ ] 蓝牙扫描功能正常
- [ ] 蓝牙连接功能正常
- [ ] 开锁功能正常（各类型锁）
- [ ] 关锁功能正常（如支持）
- [ ] 电量读取正常
- [ ] API接口调用正常
- [ ] 使用记录保存正常

---

## 总结

移植开锁功能需要特别注意：

1. **完整性**: 所有工具类、加密库必须完整复制
2. **配置一致性**: 前后端API路径、数据库字段名必须一致
3. **依赖版本**: 关键依赖的版本需要匹配
4. **平台兼容性**: uni-app蓝牙API在不同平台的兼容性
5. **加密算法**: 不同锁类型使用不同的加密方式，不能混淆
6. **数据格式**: 密码和密钥的存储格式必须与解析逻辑匹配

建议按照本指南逐步检查，确保每个环节都正确配置后再进行功能测试。

